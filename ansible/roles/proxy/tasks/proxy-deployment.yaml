---
- name: Ensures proxy dirs exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: u=rwx,g=rwx,o=rwx
  with_items:
    - "{{ PROXY_DIR }}"
    - "{{ PROXY_CERTS_DIR }}"

- name: Gather network interface facts
  ansible.builtin.setup:
    gather_subset:
      - network

- name: Copy Block Keeper keys to proxy
  ansible.builtin.copy:
    dest: "{{ PROXY_CERTS_DIR }}"
    src: "{{ item }}"
  with_list: "{{ PROXY_SIGNING_KEYS | mandatory(msg='Proxy signing key variable is required') }}"
  when: GENERATE_CERT

- name: Check that proxy certificate exists
  ansible.builtin.stat:
    path: "{{ PROXY_CERTS_DIR }}/proxy.ca.pem"
  when: not GENERATE_CERT
  register: proxy_ca_exists
  failed_when: not proxy_ca_exists.stat.exists

- name: Check that proxy key exists
  ansible.builtin.stat:
    path: "{{ PROXY_CERTS_DIR }}/proxy.key.pem"
  when: not GENERATE_CERT
  register: proxy_key_exists
  failed_when: not proxy_key_exists.stat.exists

- name: Production compose
  ansible.builtin.template:
    src: templates/compose.j2
    dest: "{{ PROXY_DIR }}/compose.yaml"
    mode: "0644"

- name: Proxy config
  ansible.builtin.template:
    src: templates/config.j2
    dest: "{{ PROXY_DIR }}/config.yaml"
    mode: "0655"

- name: Log rotate configuration
  ansible.builtin.template:
    src: templates/logrotate.j2
    dest: "{{ PROXY_DIR }}/logrotate.sh"
    mode: "0755"
  register: logrotate

- name: Compose pull
  ansible.builtin.shell:
    chdir: "{{ PROXY_DIR }}"
    cmd: docker compose pull

- name: Make sure proxy is stopped
  ansible.builtin.shell:
    chdir: "{{ PROXY_DIR }}"
    cmd: docker compose down -v
  when: GENERATE_CERT

- name: Check if proxy certificate exists for backup
  ansible.builtin.stat:
    path: "{{ PROXY_CERTS_DIR }}/proxy.ca.pem"
  register: proxy_ca_backup
  when: GENERATE_CERT

- name: Backup existing proxy certificate
  ansible.builtin.command:
    cmd: mv "{{ PROXY_CERTS_DIR }}/proxy.ca.pem" "{{ PROXY_CERTS_DIR }}/proxy.ca.pem.old"
  when: GENERATE_CERT and proxy_ca_backup.stat.exists

- name: Check if proxy key exists for backup
  ansible.builtin.stat:
    path: "{{ PROXY_CERTS_DIR }}/proxy.key.pem"
  register: proxy_key_backup
  when: GENERATE_CERT

- name: Backup existing proxy key
  ansible.builtin.command:
    cmd: mv "{{ PROXY_CERTS_DIR }}/proxy.key.pem" "{{ PROXY_CERTS_DIR }}/proxy.key.pem.old"
  when: GENERATE_CERT and proxy_key_backup.stat.exists

- name: Compose up
  ansible.builtin.shell:
    chdir: "{{ PROXY_DIR }}"
    cmd: docker compose up -d

- name: Compose restart logrotate
  ansible.builtin.shell:
    chdir: "{{ PROXY_DIR }}"
    cmd: docker compose restart logrotate
  when:
    - logrotate.changed

# Do these steps always to make sure that the proxy keys generated successfully

- name: Wait for proxy certificate to be available
  ansible.builtin.wait_for:
    path: "{{ PROXY_CERTS_DIR }}/proxy.ca.pem"
    timeout: 300
  when: GENERATE_CERT

- name: Wait for proxy key to be available
  ansible.builtin.wait_for:
    path: "{{ PROXY_CERTS_DIR }}/proxy.key.pem"
    timeout: 300
  when: GENERATE_CERT

- name: Remove existing proxy certificate backup
  ansible.builtin.file:
    path: "{{ PROXY_CERTS_DIR }}/proxy.ca.pem.old"
    state: absent
  when: GENERATE_CERT

- name: Remove existing proxy key backup
  ansible.builtin.file:
    path: "{{ PROXY_CERTS_DIR }}/proxy.key.pem.old"
    state: absent
  when: GENERATE_CERT

- name: Securely shred Block Keeper keys before removal
  ansible.builtin.command:
    cmd: "shred -u '{{ PROXY_CERTS_DIR }}/{{ item | basename }}'"
  with_list: "{{ PROXY_SIGNING_KEYS }}"
  ignore_errors: yes
  when: CLEANUP_BK_KEYS and GENERATE_CERT

- name: Remove Block Keeper keys after deployment
  ansible.builtin.file:
    dest: "{{ PROXY_CERTS_DIR }}/{{ item | basename }}"
    state: absent
  with_list: "{{ PROXY_SIGNING_KEYS }}"
  when: CLEANUP_BK_KEYS and GENERATE_CERT
