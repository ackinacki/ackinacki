#!/bin/bash

if [[ -f /.dockerenv ]] || grep -Eq '(lxc|docker)' /proc/1/cgroup; then
    echo -n
else
    echo "Docker only!"
    exit 1
fi

rm /etc/logrotate.d/*
cat >/etc/logrotate.d/node <<EOF
/logsdir/*.log {
    missingok
    rotate {{ LOG_ROTATE_AMOUNT }}
    size {{ LOG_ROTATE_SIZE }}
    notifempty
    copytruncate
}
EOF

cat /etc/logrotate.d/node

chown 0:0 /etc/logrotate.d
chown 0:0 /etc/logrotate.d/node

chmod 755 /etc/logrotate.d
chmod 644 /etc/logrotate.d/node

chmod 755 /logsdir

echo "{{ LOG_ROTATE_SPEC | default('0 *') }} * * * /bin/chmod 755 /logsdir; /usr/sbin/logrotate -v /etc/logrotate.conf" > /etc/crontabs/root
echo "{{ OPT_STATE_CLEANUP_SPEC | default('0 *') }} * * * cd /workdir/optimistic_state && ls -tp | grep -v '/$' | tail -n +{{ (OPT_STATE_KEEP_AMOUNT | default(100)) + 1 }} | tr '\n' '\0' | xargs -r -0 rm --" >> /etc/crontabs/root
echo "{{ BLK_STATE_CLEANUP_SPEC | default('0 *') }} * * * cd /workdir/blocks-states && ls -tp | grep -v '/$' | tail -n +{{ (BLK_STATE_KEEP_AMOUNT | default(100000)) + 1 }} | tr '\n' '\0' | xargs -r -0 rm --" >> /etc/crontabs/root
echo "{{ SHARE_CLEANUP_SPEC | default('0 *') }} * * * cd /share && ls -tp | grep -v '/$' | tail -n +{{ (SHARE_KEEP_AMOUNT | default(3)) + 1 }} | tr '\n' '\0' | xargs -r -0 rm --" >> /etc/crontabs/root

echo "Starting crond"

crond -f
